<html>
  <head>
    <title>Carplay MJPEG</title>
  </head>
  <style>
  body {
    width: 100%;
    margin: 0;
  }
  #carplay {
    height: 100%;
    width: 100%;
    margin: 0;
  }
  video, canvas, img {
    width: 100%;
    pointer-events:none;
  }
  </style>
  <body>
    <div id="carplay"
         ontouchstart="handleTouchStart(event)"
         ontouchend="handleTouchEnd(event)"
         ontouchmove="handleTouchMove(event)"
         onmousedown="handleMouseDown(event)"
         onmouseup="handleMouseUp(event)"
         onmousemove="handleMouseMove(event)">
          <img id="player" src="/vid.jpg" style="background-color: rgb(13, 14, 27);" />
    </div>
  </body>
  <script>
  var jmuxer;
  const carplayWidth = 900;
  const carplayHeight = 702;

  const host = window.location.hostname + ':' + window.location.port;
  var height, width, lastX, lastY, mouseDown;

  var ws = new WebSocket('ws://'+host+'/ws/control');
  ws.onopen = function () {
      ws.send(JSON.stringify({type: 'statusReq'}))
  }
  ws.onmessage = function (msg) {
      msg = JSON.parse(msg.data);
      switch (msg.type) {
        case 'statusReq':
          switch (msg.data) {
            case 'plugged':
              console.log('IPhone plugged');
              break;
            case 'unplugged':
              console.log('IPhone unplugged');
              break;
            default:
              console.log(`Unknown message data: ${msg.type} ${msg.data}`);
          };
          break;
        default:
          console.log(`Unknown message type: ${msg.type}`);
      };
  }

  var canvas = document.getElementById('player');

  width = canvas.width = window.innerWidth;
  height = canvas.height = width * carplayHeight / carplayWidth;
  var lastX = 0;
  var lastY = 0;

  function getPosition(e) {
    let c = e.target.getBoundingClientRect();
    if ("touchstart" == e.type || "touchmove" == e.type) {
      return [(e.changedTouches[0].clientX - c.left)/width,
              (e.changedTouches[0].clientY - c.top)/height];
    }
    return [(e.clientX - c.left)/width, (e.clientY - c.top)/height];
  }

  function sendData(type, x, y) {
    ws.send(JSON.stringify({
      type: 'click',
      data: {type: type, x: x, y: y}
    }));
  }

  function handleMouseDown(e) {
    let [x, y] = getPosition(e);
    mouseDown = true;
    sendData(14, x, y);
  }

  function handleMouseUp(e) {
      let [x, y] = getPosition(e);
      mouseDown = false;
      sendData(16, x, y);
  }

  function handleMouseMove(e) {
      if (mouseDown) {
        let [x, y] = getPosition(e);
        sendData(15, x, y);
      }
  }

  function handleTouchStart(e) {
      let [x, y] = getPosition(e);
      mouseDown = true;
      lastX = x;
      lastY = y;
      sendData(14, x, y);
  }

  function handleTouchEnd(e) {
      mouseDown = false;
      sendData(16, lastX, lastY);
  }

  function handleTouchMove(e) {
      if (mouseDown) {
        let [x, y] = getPosition(e);
        sendData(15, x, y);
      }
  }

  </script>
</html>
